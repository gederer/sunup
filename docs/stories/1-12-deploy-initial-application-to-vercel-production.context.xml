<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>12</storyId>
    <title>Deploy Initial Application to Vercel Production</title>
    <status>drafted</status>
    <generatedAt>2025-11-15</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/1-12-deploy-initial-application-to-vercel-production.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Developer</asA>
    <iWant>the foundation application deployed to Vercel production</iWant>
    <soThat>stakeholders can access the live application and Epic 2 features can be deployed incrementally</soThat>
    <tasks>- Deploy application to Vercel production (AC: #1, #2)
  - Create Vercel production project via dashboard or CLI
  - Link GitHub repository to Vercel project
  - Configure deployment settings (build command, output directory)
  - Deploy to production and verify deployment success
  - Configure custom domain (if available) or note Vercel subdomain

- Configure environment variables in Vercel (AC: #3)
  - Set NEXT_PUBLIC_CONVEX_URL from Convex production deployment
  - Set NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY from Clerk production instance
  - Set CLERK_SECRET_KEY from Clerk production instance
  - Set CLERK_WEBHOOK_SECRET for Clerk webhook security
  - Verify all required environment variables are set
  - Redeploy application to apply environment variables

- Create and link Convex production deployment (AC: #4)
  - Run `npx convex deploy --prod` to create production deployment
  - Copy production deployment URL
  - Update NEXT_PUBLIC_CONVEX_URL in Vercel environment variables
  - Verify Convex schema deployed correctly
  - Test database connection from production app

- Configure Clerk production instance (AC: #5)
  - Create Clerk production instance (or verify existing)
  - Configure redirect URLs with production domain/subdomain
  - Add production URL to allowed origins
  - Update webhook endpoint URL to production domain
  - Verify Clerk authentication keys match Vercel environment variables
  - Test webhook delivery to production endpoint

- Perform smoke tests (AC: #6)
  - Test sign-in flow: Navigate to production URL → Click sign-in → Authenticate successfully
  - Test protected route: After sign-in, navigate to dashboard → Verify access granted
  - Test role-based access: Sign in as System Administrator → Verify correct role assigned
  - Test multi-tenant isolation: Verify tenantId correctly set in Clerk metadata
  - Test Convex connection: Verify queries execute and return data
  - Document any issues found and resolve

- Update documentation (AC: #7)
  - Add production URL to README.md
  - Document deployment process in README.md
  - Add deployment badge (optional) to README.md
  - Share production URL with team (Slack, email, or project documentation)</tasks>
  </story>

  <acceptanceCriteria>1. Application deployed to Vercel production environment
2. Custom domain configured (if available) or Vercel subdomain accessible
3. Environment variables configured in Vercel dashboard
4. Convex production deployment linked to Vercel app
5. Clerk production instance configured with correct redirect URLs
6. Smoke test verifies: Sign-in works, protected route accessible with correct role
7. Production URL documented in README.md and shared with team</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture Documentation</title>
        <section>Deployment Architecture</section>
        <snippet>Vercel for web (Next.js optimized, edge network, serverless functions), Convex Cloud for backend (serverless, auto-scaling, real-time), Clerk for auth. Environment strategy: Local dev → Staging (Vercel previews) → Production. CI/CD: Git push triggers auto-deploy to Vercel and Convex with testing gates (Vitest, type-check, linting).</snippet>
      </doc>
      <doc>
        <path>docs/stories/1-11-setup-git-hub-actions-ci-cd-pipeline.md</path>
        <title>Story 1.11 - CI/CD Pipeline Setup</title>
        <section>Learnings from Previous Story</section>
        <snippet>GitHub Actions workflow operational at .github/workflows/ci.yml. CI job runs on every PR: lint, type-check, test (129 passing). CD job deploys to Vercel on main branch push. Vercel CLI pattern: pull → build → deploy. GitHub secrets configured: VERCEL_TOKEN, VERCEL_ORG_ID, VERCEL_PROJECT_ID. App env vars managed in Vercel dashboard.</snippet>
      </doc>
      <doc>
        <path>README.md</path>
        <title>Project README</title>
        <section>CI/CD Pipeline</section>
        <snippet>CI runs lint, type-check, test on every PR. CD deploys to Vercel on main push. Required GitHub secrets: VERCEL_TOKEN, VERCEL_ORG_ID, VERCEL_PROJECT_ID. App environment variables (Convex URL, Clerk keys) configured in Vercel dashboard. Branch protection recommended for main branch requiring CI pass before merge.</snippet>
      </doc>
      <doc>
        <path>docs/testing.md</path>
        <title>Testing Documentation</title>
        <section>Testing Standards</section>
        <snippet>Vitest for unit tests, Playwright for E2E (deferred to Epic 2). 129+ tests passing. Convex-test library for testing Convex functions. Test command: pnpm test. Tests must pass before merge.</snippet>
      </doc>
      <doc>
        <path>docs/stories/1-5-integrate-clerk-authentication.md</path>
        <title>Story 1.5 - Clerk Authentication</title>
        <section>Implementation Details</section>
        <snippet>Clerk provides OAuth2, passwordless auth with magic links, MFA support. Webhook-based user sync to Convex. Production instance requires separate keys. Multi-tenant support via metadata. Webhook endpoint: /api/webhooks/clerk. Redirect URLs must include production domain.</snippet>
      </doc>
      <doc>
        <path>docs/stories/1-3-initialize-convex-backend-and-database.md</path>
        <title>Story 1.3 - Convex Backend Setup</title>
        <section>Convex Deployment</section>
        <snippet>Convex backend deployed via npx convex deploy --prod for production. Development uses local dev deployment. Schema auto-deployed from packages/convex/schema.ts. All queries, mutations, actions deployed. Requires Convex account.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>.github/workflows/ci.yml</path>
        <kind>ci-cd-pipeline</kind>
        <symbol>CI/CD Workflow</symbol>
        <lines>1-102</lines>
        <reason>GitHub Actions workflow already configured for automated deployment. CI job runs lint/type-check/test, CD job deploys to Vercel on main push. Uses secrets: VERCEL_TOKEN, VERCEL_ORG_ID, VERCEL_PROJECT_ID. Deploy pattern: vercel pull → build → deploy --prebuilt --prod.</reason>
      </artifact>
      <artifact>
        <path>apps/web/middleware.ts</path>
        <kind>middleware</kind>
        <symbol>clerkMiddleware</symbol>
        <lines>1-23</lines>
        <reason>Clerk authentication middleware protecting /profile and /dashboard routes. Must work in production with correct Clerk production keys and redirect URLs.</reason>
      </artifact>
      <artifact>
        <path>apps/web/next.config.ts</path>
        <kind>config</kind>
        <symbol>nextConfig</symbol>
        <lines>1-7</lines>
        <reason>Next.js configuration file for web app. Currently minimal but may need Vercel-specific settings.</reason>
      </artifact>
      <artifact>
        <path>packages/convex/schema.ts</path>
        <kind>schema</kind>
        <symbol>defineSchema</symbol>
        <lines>1-50</lines>
        <reason>Convex database schema defining organizations, people, and multi-tenant structure. Will be deployed to production Convex deployment via npx convex deploy --prod.</reason>
      </artifact>
      <artifact>
        <path>apps/web/package.json</path>
        <kind>config</kind>
        <symbol>package.json</symbol>
        <lines>1-56</lines>
        <reason>Web app dependencies including @clerk/nextjs, convex, next 16.0.0. Build script: next build. Dependencies must be installed on Vercel.</reason>
      </artifact>
    </code>
    <dependencies>
      <node>
        <package name="next" version="16.0.0" type="production"/>
        <package name="react" version="19.2.0" type="production"/>
        <package name="react-dom" version="19.2.0" type="production"/>
        <package name="@clerk/nextjs" version="^6.34.0" type="production"/>
        <package name="convex" version="^1.28.0" type="production"/>
        <package name="@sunup/convex" version="workspace:*" type="production"/>
        <package name="@sunup/ui" version="workspace:*" type="production"/>
        <package name="@sunup/types" version="workspace:*" type="production"/>
        <package name="tailwindcss" version="^4" type="development"/>
        <package name="typescript" version="^5" type="development"/>
      </node>
      <system>
        <tool name="pnpm" version="10.20.0" required="true"/>
        <tool name="node" version="18.x" required="true"/>
        <tool name="vercel-cli" version="latest" required="true"/>
      </system>
    </dependencies>
  </artifacts>

  <constraints>- Deployment target: Vercel platform optimized for Next.js
- Build command: pnpm build (runs Turborepo build pipeline)
- Output directory: apps/web/.next
- Node.js version: 18.x (matches CI environment)
- Package manager: pnpm 10.20.0 with frozen lockfile
- Environment variables MUST be configured in Vercel dashboard (never in code or GitHub secrets)
- Required env vars: NEXT_PUBLIC_CONVEX_URL, NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY, CLERK_SECRET_KEY, CLERK_WEBHOOK_SECRET
- Convex production deployment MUST be created separately via npx convex deploy --prod
- Clerk production instance MUST have redirect URLs matching production domain
- All 129+ tests must pass before deployment
- Zero-downtime deployments via Vercel rolling updates
- HTTPS/TLS 1.3+ enforced for all connections
- Multi-tenant RLS enforced at Convex query layer
- Webhook signature verification required for Clerk webhooks
- Production URL must be documented in README.md after deployment
- CI/CD pipeline already operational via GitHub Actions (.github/workflows/ci.yml)</constraints>
  <interfaces>
    <interface>
      <name>Vercel Deployment API</name>
      <kind>CLI</kind>
      <signature>vercel pull --yes --environment=production --token=$TOKEN
vercel build --prod --token=$TOKEN
vercel deploy --prebuilt --prod --token=$TOKEN</signature>
      <path>.github/workflows/ci.yml</path>
    </interface>
    <interface>
      <name>Convex Production Deployment</name>
      <kind>CLI</kind>
      <signature>npx convex deploy --prod</signature>
      <path>packages/convex/</path>
    </interface>
    <interface>
      <name>Clerk Webhook Endpoint</name>
      <kind>REST API</kind>
      <signature>POST /api/webhooks/clerk - Receives user sync events from Clerk. Requires CLERK_WEBHOOK_SECRET for signature verification.</signature>
      <path>apps/web/app/api/webhooks/clerk/ (to be verified)</path>
    </interface>
    <interface>
      <name>Clerk Middleware</name>
      <kind>Next.js Middleware</kind>
      <signature>clerkMiddleware(async (auth, req) => { ... }) - Protects routes requiring authentication</signature>
      <path>apps/web/middleware.ts</path>
    </interface>
  </interfaces>
  <tests>
    <standards>Vitest for unit and integration tests. Playwright for E2E tests (deferred to Epic 2). 129+ tests passing with 88%+ coverage. Convex-test library (v0.0.38) for testing Convex functions with authentication context. Coverage target: 95%+ for authentication and core business logic. TypeScript strict mode. Tests must pass before deployment via GitHub Actions CI.</standards>
    <locations>packages/convex/tests/*.test.ts - Unit and integration tests for Convex backend
apps/web/**/*.test.{ts,tsx} - Component tests (when implemented)
packages/convex/tests/*-integration.test.ts - Integration tests
E2E tests deferred to Epic 2</locations>
    <ideas>
      <idea ac="AC1">Smoke test: Verify production deployment URL is accessible and returns HTTP 200</idea>
      <idea ac="AC2">Smoke test: Verify custom domain DNS resolves correctly (if configured), otherwise verify Vercel subdomain accessible</idea>
      <idea ac="AC3">Manual verification: Check Vercel dashboard shows all required environment variables (NEXT_PUBLIC_CONVEX_URL, NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY, CLERK_SECRET_KEY, CLERK_WEBHOOK_SECRET)</idea>
      <idea ac="AC4">Smoke test: Verify production app can connect to Convex production deployment by checking network requests in browser DevTools</idea>
      <idea ac="AC5">Smoke test: Test Clerk redirect URLs - navigate to sign-in page, verify OAuth flow redirects correctly back to production domain</idea>
      <idea ac="AC6">Manual smoke test suite as documented in story tasks: (1) Sign-in flow end-to-end, (2) Protected route access after auth, (3) Role verification (System Admin), (4) Multi-tenant tenantId in Clerk metadata, (5) Convex queries execute successfully</idea>
      <idea ac="AC7">Verify README.md updated with production URL and deployment instructions. Check git commit shows changes.</idea>
      <idea ac="all">Pre-deployment: Ensure all 129+ tests pass locally with pnpm test before triggering production deployment</idea>
      <idea ac="all">Monitor GitHub Actions workflow logs during deployment to catch any build or deployment errors</idea>
      <idea ac="all">Check Convex production dashboard after deployment to verify schema and functions deployed correctly</idea>
    </ideas>
  </tests>
</story-context>
